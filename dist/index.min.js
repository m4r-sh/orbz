var S=function(q,B){let H=new Set([...q].filter((J)=>!B.has(J))),z=new Set([...B].filter((J)=>!q.has(J))),K={};Array.from([...B]).forEach((J)=>{if(J.indexOf(".")>0){let Q=J.substring(0,J.indexOf(".")),X=J.substring(J.indexOf(".")+1);if(K[Q])K[Q].add(X);else K[Q]=new Set([X]);z.delete(J)}});let G=Object.keys(K).map((J)=>[J,K[J]]);return[H,z,G]},I=0,A=[],Y=null,x="",w=Symbol("orbz-core");class R{#A={};#W={};#B={};#K=new Set;#R={};#Q={};#X={};#G={};#z;#H=new Map;#q={};#J={};#I={};#Y=!1;#U(){return Y==this||!this.#Y}#N(q){let B=A.length;if(B!=0)A[B-1].add(x+q),x=""}#T(){A.push(new Set)}#V(){return A.splice(A.length-1,1)[0]}#j(q){if(this.#Q[q])return this.#R[q];else{this.#T();let B=this.#J[q],H=this.#X[q](),z=this.#V(),[K,G,J]=S(B,z);return K.forEach((Q)=>{this.#q[Q].delete(q),this.#J[q].delete(Q)}),G.forEach((Q)=>{if(this.#q[Q])this.#q[Q].add(q);this.#J[q].add(Q)}),J.forEach(([Q,X])=>{this.#B[Q].$((V)=>{})}),this.#R[q]=H,this.#Q[q]=!0,H}}#F(q,B=!1){if(this.#Y){if(B||this.#Q[q]){if(this.#K.add(q),!B)this.#Q[q]=!1;this.#q[q].forEach((H)=>this.#F(H))}}}#P(){if(I==0&&this.#K.size>0)this.#H.forEach((q,B)=>{if(q==null||[...q].some((H)=>this.#K.has(H))){q=new Set,this.#T(),B(this.#z);let H=this.#V(),[z,K,G]=S(q,H);if(z.forEach((J)=>{q.delete(J)}),K.forEach((J)=>{q.add(J)}),G.forEach(([J,Q])=>{}),q.size==0)this.#H.delete(B);else this.#H.set(B,q)}}),this.#K.clear()}constructor(q,B,H){this.#z=H,this.#A=q.orbs;for(let z in q.state)this.#q[z]=new Set,this.set_state(z,z in B?B[z]:structuredClone(q.state[z]));for(let z in q.orbs)this.#q[z]=new Set,this.set_orb(z,B[z]);for(let z in q.entry)this.#G[z]=q.entry[z].bind(this.#z);for(let z in q.async)this.#G[z]=q.async[z].bind(this.#z);for(let z in q.derived)this.#q[z]=new Set,this.#J[z]=new Set,this.#X[z]=q.derived[z].bind(this.#z);for(let z in q.getset)this.#q[z]=new Set,this.#J[z]=new Set,this.#X[z]=q.getset[z].get.bind(this.#z),this.#G[z]=q.getset[z].set.bind(this.#z);this.#Y=!0}add_link(q,B){let H=this.#I[q];return(z)=>{return H.add(z),()=>{H.delete(z)}}}add_sub(q,B){return this.#H.set(q,null),()=>{this.#H.delete(q)}}get_state(q){if(!q.startsWith("_")||this.#U())return this.#N(q),this.#W[q]}set_state(q,B){if(!q.startsWith("_")||this.#U()){if(B!=this.#W[q])this.#W[q]=B,this.#F(q,!0),this.#P()}}get_derived(q){if(!q.startsWith("_")||this.#U()){this.#N(q);let B;const H=Y;Y=this;try{B=this.#j(q)}finally{Y=H}return B}}run_entrypoint(q,B,{async:H=!1}={}){if(!q.startsWith("_")||this.#U()){if(this.#G[q]){let z;const K=Y;if(!H)Y=this,I++;try{z=this.#G[q](...B)}finally{Y=K}if(H)return z.then((G)=>{return this.#P(),G});else return I--,this.#P(),z}}}set_orb(q,B){let H=this.#A[q];if(B&&B instanceof H)this.#B[q]=B;else if(B&&typeof B=="object")this.#B[q]=new H({...B});else this.#B[q]=null}get_orb(q){return this.#N(q),this.#B[q]}}var U=Symbol("orb-core"),h=Symbol("list-core"),T=Symbol("m-self"),p=Symbol("orbz-ismodel"),P=Symbol("model-def"),N=Symbol("model-id"),F=Symbol("model-id");var W=function(){let{defs:q,types:B}=$(arguments[arguments.length-1]),H=Symbol("unique-model-id"),z=[H];for(let G=arguments.length-2;G>=0;G--)q=m(arguments[G][P],q),z.push(...arguments[G][N]);function K(G={}){if(!new.target)return new K(G);Object.defineProperty(this,U,{value:new R(q,G,this)}),Object.defineProperty(this,F,{value:z}),Object.preventExtensions(this)}return Object.defineProperty(K,Symbol.hasInstance,{value:function(G){return G&&G[F]&&G[F].includes(H)}}),K[P]=q,K[N]=z,K.toString=function(){return O(q)},Object.keys(q.orbs).forEach((G)=>{if(q.orbs[G]==T)q.orbs[G]=K}),Object.keys(q.entry).forEach((G)=>{Object.defineProperty(K.prototype,G,{value:function(){return this[U].run_entrypoint(G,arguments,{async:!1})}})}),Object.keys(q.async).forEach((G)=>{Object.defineProperty(K.prototype,G,{value:function(){return this[U].run_entrypoint(G,arguments,{async:!0})}})}),Object.keys(q.derived).forEach((G)=>{Object.defineProperty(K.prototype,G,{get(){return this[U].get_derived(G)},enumerable:!G.startsWith("_")})}),Object.keys(q.getset).forEach((G)=>{Object.defineProperty(K.prototype,G,{get(){return this[U].get_derived(G)},set(J){return this[U].run_entrypoint(G,[J])},enumerable:!G.startsWith("_")})}),Object.keys(q.state).forEach((G)=>{Object.defineProperty(K.prototype,G,{get(){return this[U].get_state(G)},set(J){this[U].set_state(G,J)},enumerable:!G.startsWith("_")})}),Object.keys(q.orbs).forEach((G)=>{Object.defineProperty(K.prototype,G,{get(){return this[U].get_orb(G)},set(J){this[U].set_orb(G,J)},enumerable:!G.startsWith("_")})}),Object.defineProperties(K.prototype,D),K},$=function(q){let B={state:{},derived:{},entry:{},orbs:{},getset:{},async:{}},H={},z=Object.getOwnPropertyDescriptors(q);return Object.keys(z).forEach((K)=>{let G,J,{value:Q,get:X,set:V}=z[K];if(X&&V)G="getset",J={get:X,set:V};else if(X)J=X,G="derived";else if(V)console.log("TODO: lone setter");else if(J=Q,typeof Q=="function")if(Q instanceof W)G="orbs";else if(Q.constructor.name=="AsyncFunction")G="async";else G="entry";else if(Q==T)G="orbs";else G="state";H[K]=G,B[G][K]=J}),{types:H,defs:B}},m=function(q,B){const H={...q,...B};for(let z of Object.keys(H))H[z]=typeof q[z]=="object"&&typeof B[z]=="object"?m(q[z],B[z]):H[z];return H};function O({state:q,derived:B,entry:H,orbs:z,getset:K,async:G}){let J="{\n";return J+=Object.keys(q).map((Q)=>`${Q}:${j(q[Q],Q)}`).join(",\n"),J+=",\n",J+=Object.keys(B).map((Q)=>`${B[Q]}`).join(",\n"),J+=",\n",J+=Object.keys(H).map((Q)=>`${H[Q]}`).join(",\n"),J+=",\n",J+="}",J}var D={$:{value:function(q,B){if(typeof q=="function")return this[U].add_sub(q,B);else if(typeof q=="string")return this[U].add_link(q,B)}},$invalidate:{value:function(q){this[U].inval(q)}}};W.self=()=>T;W.stringify=function(q){return O(q[P])};Object.defineProperty(W,Symbol.hasInstance,{value(q){return q&&Object.hasOwn(q,N)}});Object.defineProperty(W,"toString",{value(q){return q&&Object.hasOwn(q,N)}});/*! (c) Andrea Giammarchi - ISC */var L=(q)=>"{"+Object.keys(q).map((B)=>{const{get:H,set:z,value:K}=Object.getOwnPropertyDescriptor(q,B);if(H&&z)B=H+","+z;else if(H)B=""+H;else if(z)B=""+z;else B=JSON.stringify(B)+":"+j(K,B);return B}).join(",")+"}",j=(q,B)=>{const H=typeof q;if(H==="function")return q.toString().replace(new RegExp("^(\\*|async )?\\s*"+B+"[^(]*?\\("),(z,K)=>K==="*"?"function* (":(K||"")+"function (");if(H==="object"&&q)return Array.isArray(q)?E(q):L(q);return JSON.stringify(q)},E=(q)=>"["+q.map(j).join(",")+"]";var C=function(q){return W(q)()};Object.defineProperty(C,Symbol.hasInstance,{value(q){return q&&q[U]&&q[U]instanceof R}});function Z(q){return{def:q[P],models:q[N]}}export{Z as inspect,C as Orb,W as Model};
